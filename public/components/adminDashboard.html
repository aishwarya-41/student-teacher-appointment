<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" type="text/css" href="../components/css/admin.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js";
    import { getFirestore, collection, query, getDocs, doc, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcRXCUIRuODy_NK9LHRcu9HtiQcCuCmlI",
      authDomain: "student-teacher-appointm-d130e.firebaseapp.com",
      projectId: "student-teacher-appointm-d130e",
      storageBucket: "student-teacher-appointm-d130e.appspot.com",
      messagingSenderId: "138490773111",
      appId: "1:138490773111:web:5484c85e5f1180d21f5072",
      measurementId: "G-V6T3RVCPGX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function fetchUsers() {
      try {
        const usersQuery = query(collection(db, 'users'));
        const querySnapshot = await getDocs(usersQuery);

        const usersList = document.getElementById('users-list');
        usersList.innerHTML = "";

        for (const userDoc of querySnapshot.docs) {
          const userData = userDoc.data();
          const userId = userDoc.id;
          const role = userData.role;
          const name = userData.name;

          const userElement = document.createElement('div');
          userElement.innerHTML = `
            <p>Name: ${name}</p>
            <p>Role: ${role}</p>
            ${role === 'student' ? '<button onclick="removeStudent(\'' + userId + '\')">Remove Student</button>' : ''}
            ${role === 'teacher' ? '<button onclick="removeTeacher(\'' + userId + '\')">Remove Teacher</button>' : ''}
            ${role === 'teacher' ? '<button onclick="updateTeacher(\'' + userId + '\')">Update Teacher</button>' : ''}
            <div id="appointments-${userId}"></div>
          `;

          usersList.appendChild(userElement);
        }
      } catch (error) {
        console.error('Error fetching users:', error.message);
      }
    }

    async function removeStudent(studentId) {
      try {
        // Delete student from users collection
        await deleteDoc(doc(db, 'users', studentId));

        // Optionally, delete student's appointments
        const appointmentsQuery = query(collection(db, 'appointments'), where('studentId', '==', studentId));
        const appointmentsSnapshot = await getDocs(appointmentsQuery);
        for (const appointmentDoc of appointmentsSnapshot.docs) {
          await deleteDoc(doc(db, 'appointments', appointmentDoc.id));
        }

        // Refresh user list
        fetchUsers();
      } catch (error) {
        console.error('Error removing student:', error.message);
      }
    }

    async function removeTeacher(teacherId) {
      try {
        // Delete teacher from users collection
        await deleteDoc(doc(db, 'users', teacherId));

        // Optionally, delete teacher's appointments
        const appointmentsQuery = query(collection(db, 'appointments'), where('teacherId', '==', teacherId));
        const appointmentsSnapshot = await getDocs(appointmentsQuery);
        for (const appointmentDoc of appointmentsSnapshot.docs) {
          await deleteDoc(doc(db, 'appointments', appointmentDoc.id));
        }

        // Refresh user list
        fetchUsers();
      } catch (error) {
        console.error('Error removing teacher:', error.message);
      }
    }

    async function updateTeacher(teacherId) {
      const newName = prompt('Enter new name for the teacher:');
      if (newName) {
        try {
          const teacherRef = doc(db, 'users', teacherId);
          await updateDoc(teacherRef, { name: newName });
          console.log(`Teacher ${teacherId} updated.`);
          fetchUsers(); // Refresh user list
        } catch (error) {
          console.error('Error updating teacher:', error.message);
        }
      }
    }

    async function logout() {
      try {
        await signOut(auth);
        console.log('User signed out.');
        // Redirect to login page or another appropriate action
        window.location.href = 'login.html'; // Adjust path as necessary
      } catch (error) {
        console.error('Error signing out:', error.message);
      }
    }

    window.removeStudent = removeStudent; // Expose the function globally
    window.removeTeacher = removeTeacher; // Expose the function globally
    window.updateTeacher = updateTeacher; // Expose the function globally
    window.logout = logout; // Expose the function globally

    onAuthStateChanged(auth, (user) => {
      if (user) {
        fetchUsers();
      } else {
        console.log('User is signed out.');
        // Redirect to login or handle sign-out state as needed
        window.location.href = 'login.html'; // Adjust path as necessary
      }
    });
  </script>
</head>
<body>
  <h1>Admin Dashboard</h1>
  <div id="users-list">
    <!-- Users will be dynamically listed here -->
  </div>
  <button id="logout" onclick="logout()">Logout</button>
</body>
</html>
